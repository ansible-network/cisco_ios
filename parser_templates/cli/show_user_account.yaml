---
- name: parser meta data
  parser_metadata:
    version: 1.0
    command: show running-config | section user
    network_os: ios

- name: "match users section"
  pattern_match:
    regex: "username .+"
    match_all: yes
    match_greedy: yes
  register: section

- name: "match user values"
  pattern_group:
    - name: "match name"
      pattern_match:
        regex: "username (\\S+)"
        content: "{{ item }}"
      register: name
    
    - name: "match privilege"
      pattern_match:
        regex: "privilege (\\d+)"
        content: "{{ item }}"
      register: privilege

    - name: "match view"
      pattern_match:
        regex: "view (\\S+)"
        content: "{{ item }}"
      register: view

  loop: "{{ section }}"
  register: users

- name: generate json data structure
  json_template:
    template:
      - key: name
        value: "{{ item.name.matches.0 }}"
      - key: privilege
        value: "{{ item.privilege.matches.0 }}"
        when: item.privilege.matches.0 is defined
      - key: view
        value: "{{ item.view.matches.0 }}"
        when: item.view.matches.0 is defined
  loop: "{{ users }}"
  export: yes
  register: user_account_facts
